<Project>
  <PropertyGroup>
    <PluginConfigFile>$(TargetDir)plugin.config</PluginConfigFile>
    <MSBuildAllProjects>$(MSBuildAllProjects);$(MSBuildThisFileFullPath)</MSBuildAllProjects>
  </PropertyGroup>

  <ItemGroup>
    <Content Include="$(PluginConfigFile)">
      <Visible>false</Visible>
      <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
      <CopyToPublishDirectory>PreserveNewest</CopyToPublishDirectory>
    </Content>
  </ItemGroup>

  <Target Name="GeneratePluginConfig"
          BeforeTargets="Build"
          Inputs="$(MSBuildAllProjects);$(TargetPath)"
          Outputs="$(PluginConfigFile)"
          Condition=" '$(IsPlugin)' == 'true' AND '$(TargetFramework)' != '' ">
    <PropertyGroup>
      <PluginConfigContent>
        <![CDATA[
<PluginConfig MainAssembly="$(AssemblyName), Version=$(AssemblyVersion)">
  @(PrivateDependency->'<PrivateDependency Identity="%(Identity)" />', '%0A  ')
</PluginConfig>
]]>
      </PluginConfigContent>
    </PropertyGroup>

    <WriteLinesToFile Lines="$(PluginConfigContent)" Overwrite="true" File="$(PluginConfigFile)" />

    <ItemGroup>
      <FileWrites Include="$(PluginConfigFile)" />
    </ItemGroup>
  </Target>
</Project>
